{% extends 'core/base.html' %}
{% block title %}Home{% endblock %}
{% block content %}

<style>
  /* Ensure story thumbnails are always small circles */
  .story-thumb {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    display: block;
    background: #f2f2f2;
  }

  .story-thumb img,
  .story-thumb video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    pointer-events: none;
  }

  .story-ring {
    display: inline-block;
    padding: 2px;
    border: 3px solid #ff004f;
    border-radius: 50%;
    cursor: pointer;
  }

  .story-ring.viewed {
    border-color: #ddd;
  }
</style>

<!-- üîµ Stories bar -->
<div class="mb-4 d-flex gap-3 align-items-center overflow-auto">
  {% if request.user.is_authenticated %}
  <a class="btn btn-sm btn-primary me-2" href="{% url 'add_story' %}">Add Story</a>
  {% endif %}

  {% for item in stories %}
  {% with u=item.user s=item.story %}
  <button type="button" class="btn p-0 border-0 bg-transparent story-button" data-bs-toggle="modal"
    data-bs-target="#storyModal" data-media="{{ s.media.url }}" data-user="{{ u.username }}" data-story-id="{{ s.id }}">
    <span class="story-ring {% if not item.unviewed %}viewed{% endif %}">
      <span class="story-thumb">
        {% if s.is_video %}
        <video src="{{ s.media.url }}" muted loop playsinline></video>
        {% else %}
        <img src="{{ s.media.url }}" alt="@{{ u.username }}">
        {% endif %}
      </span>
    </span>
  </button>
  {% endwith %}
  {% empty %}
  <p class="text-muted">No stories yet.</p>
  {% endfor %}
</div>

<!-- üîµ Story viewer modal -->
<div class="modal fade" id="storyModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content story-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="storyUser"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="storyImage" class="img-fluid d-none" alt="" style="max-height:70vh; width:auto; object-fit:contain;">
        <video id="storyVideo" class="w-100 d-none" controls autoplay playsinline
          style="max-height:70vh; object-fit:contain;"></video>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Note: Modal display logic is handled in apps.js.
  // We only need to handle the "viewed" status update here.
  var storyModal = document.getElementById('storyModal');
  if (storyModal) {
    storyModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const storyId = button.getAttribute('data-story-id');

      // mark viewed via AJAX
      fetch("{% url 'mark_story_viewed' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ 'story_id': storyId })
      }).then(r => r.json()).then(data => {
        if (data.ok) {
          // find the originating button and mark viewed
          document.querySelectorAll('[data-story-id="' + storyId + '"]').forEach(el => {
            const ring = el.querySelector('.story-ring');
            if (ring) ring.classList.add('viewed');
          });
        }
      }).catch(() => { });
    });
  }
</script>

<!-- üîµ Posts feed -->
{% for post in posts %}
<div class="card mb-4 shadow-sm">
  <div class="card-body d-flex justify-content-between align-items-center">
    <div>
      <strong>@{{ post.author.username }}</strong>
      <span class="text-muted"> ¬∑ {{ post.created_at|date:"M d, H:i" }}</span>
    </div>
    {% if request.user != post.author %}
    {% if post.author.id in following_ids %}
    <button class="btn btn-sm btn-outline-secondary follow-btn"
      data-username="{{ post.author.username }}">Unfollow</button>
    {% else %}
    <button class="btn btn-sm btn-outline-primary follow-btn" data-username="{{ post.author.username }}">Follow</button>
    {% endif %}
    {% endif %}
  </div>

  <!-- Consistent aspect ratio for media -->
  <div class="post-media mb-3">
    {% if post.is_video %}
    <video src="{{ post.media.url }}" controls playsinline></video>
    {% else %}
    <img src="{{ post.media.url }}" alt="">
    {% endif %}
  </div>

  <div class="card-body">
    {% if post.caption %}
    <p class="mb-2">{{ post.caption }}</p>
    {% endif %}

    <div class="d-flex align-items-center gap-3 mb-2">
      <button class="btn btn-sm btn-outline-danger like-btn" data-post="{{ post.id }}">
        ‚ù§Ô∏è <span class="like-count">{{ post.likes.count }}</span>
      </button>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#c{{ post.id }}">
        üí¨ <span class="comment-count">{{ post.comments.count }}</span>
      </button>
    </div>

    <div class="collapse" id="c{{ post.id }}">
      <ul class="list-group mb-2" id="comments-{{ post.id }}">
        {% for c in post.comments.all %}
        <li class="list-group-item">
          <strong>@{{ c.author.username }}</strong> {{ c.text }}
          <small class="text-muted float-end">{{ c.created_at|timesince }} ago</small>
        </li>
        {% endfor %}
      </ul>
      <form class="d-flex comment-form" data-post="{{ post.id }}">
        {% csrf_token %}
        <input class="form-control me-2" name="text" placeholder="Add a comment...">
        <button class="btn btn-primary">Post</button>
      </form>
    </div>
  </div>
</div>
{% empty %}
<p class="text-muted">No posts yet. Share your first post from Create.</p>
{% endfor %}

{% endblock %}